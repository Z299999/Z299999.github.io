<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eco-Evo Graph Simulation</title>
  <link rel="stylesheet" href="styles.css">
  <!-- CDN libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
</head>
<body>

  <!-- Top toolbar -->
  <header id="toolbar">
    <div class="toolbar-group">
      <button id="btn-play" title="Play / Pause">Play</button>
      <button id="btn-step" title="Single step">Step</button>
      <button id="btn-reset" title="Reset simulation">Reset</button>
      <button id="btn-test-toggle" title="Impulse response test">Start test</button>
    </div>
    <div class="toolbar-group toolbar-stats">
      <span>t = <strong id="stat-step">0</strong></span>
      <span>Nodes: <strong id="stat-nodes">0</strong></span>
      <span>Edges: <strong id="stat-edges">0</strong></span>
    </div>
    <div class="toolbar-group">
      <label>Speed
        <input type="range" id="param-speed" min="1" max="200" value="10" step="1">
        <span id="param-speed-val">10</span> steps/s
      </label>
    </div>
  </header>

  <!-- Main layout: left panel | center graph | right chart -->
  <main id="layout">

    <!-- Left: control panel -->
    <aside id="panel-left">
      <h3>Parameters</h3>

      <fieldset>
        <legend>Genesis (apply on Reset)</legend>
        <label class="inline-pair">
          <span>m (inputs)</span>
          <input type="number" id="param-m" min="1" max="50" value="1">
          <span>n (outputs)</span>
          <input type="number" id="param-n" min="1" max="50" value="1">
        </label>
        <label>
          k (internal nodes)
          <input type="number" id="param-k" min="1" max="50" value="9">
        </label>
        <label>
          Graph construction
          <select id="param-construction">
            <option value="bridge" selected>Bridging growth</option>
            <option value="random">Random growth</option>
          </select>
        </label>
        <label>
          Input source
          <select id="param-input-source">
            <option value="noise">Noise</option>
            <option value="constant">Constant (1)</option>
            <option value="sine">Sine</option>
          </select>
        </label>
        <label>
          Activation
          <select id="param-activation">
            <option value="tanh" selected>tanh</option>
            <option value="relu">ReLU</option>
            <option value="relu-thresh">ReLU (with threshold)</option>
            <option value="identity">Identity</option>
            <option value="maxabs">max |w_i x_i|</option>
          </select>
        </label>
        <label>
          Edge weight control
          <select id="param-weight-control">
            <option value="vanilla" selected>drifted Brownian motion</option>
            <option value="tanh">drifted BM with tanh constraint</option>
            <option value="ou">Ornstein–Uhlenbeck (OU)</option>
          </select>
        </label>
      </fieldset>

      <fieldset id="fieldset-runtime">
        <legend>Runtime</legend>
        <label>
          &mu; (drift)
          <input type="range" id="param-mu" min="-0.1" max="0.1" value="0.0" step="0.001">
          <span id="param-mu-val">0.01</span>
        </label>
        <label>
          p_flip (flip probability)
          <input type="range" id="param-pflip" min="0" max="1" value="0.3" step="0.01">
          <span id="param-pflip-val">0.3</span>
        </label>
        <label>
          T_bridge (bridging threshold)
          <input type="range" id="param-tbridge" min="0" max="1" value="0.8" step="0.01">
          <span id="param-tbridge-val">0.8</span>
        </label>
        <label>
          &sigma; (mutation)
          <input type="range" id="param-sigma" min="0" max="0.05" value="0.02" step="0.001">
          <span id="param-sigma-val">0.02</span>
        </label>
        <label>
          &omega; (bridge feedback)
          <input type="range" id="param-omega" min="0" max="0.2" value="0.05" step="0.005">
          <span id="param-omega-val">0.05</span>
        </label>
        <label>
          &epsilon; (near-zero threshold)
          <input type="range" id="param-epszero" min="0" max="0.01" value="0.001" step="0.0001">
          <span id="param-epszero-val">0.001</span>
        </label>
        <label>
          K (bridge cooldown)
          <input type="range" id="param-K" min="0" max="50" value="10" step="1">
          <span id="param-K-val">10</span>
        </label>
        <label>
          &theta; (activation threshold)
          <input type="range" id="param-theta" min="0" max="1" value="0" step="0.01">
          <span id="param-theta-val">0.0</span>
        </label>
        <label>
          m (OU mean)
          <input type="range" id="param-ou-mean" min="-1" max="1" value="0" step="0.05">
          <span id="param-ou-mean-val">0.0</span>
        </label>
      </fieldset>

      <fieldset id="fieldset-test" style="display: none;">
        <legend>Impulse test (frozen graph)</legend>
        <label>
          Input index (i)
          <input type="number" id="param-test-input" min="0" value="0" step="1">
        </label>
        <label>
          Amplitude A
          <input type="number" id="param-test-amp" min="0" value="1" step="0.1">
        </label>
        <label>
          Test steps
          <input type="number" id="param-test-steps" min="1" value="200" step="10">
        </label>
        <button id="btn-test-inject" type="button">Inject</button>
        <button id="btn-test-stop-recording" type="button">Stop</button>
      </fieldset>

      <div class="legend-box">
        <h4>Legend</h4>
        <div class="legend-item"><span class="dot dot-input"></span> Input node</div>
        <div class="legend-item"><span class="dot dot-internal"></span> Internal node</div>
        <div class="legend-item"><span class="dot dot-output"></span> Output node</div>
        <div class="legend-item"><span class="line line-pos"></span> Positive weight</div>
        <div class="legend-item"><span class="line line-neg"></span> Negative weight</div>
        <div class="legend-item"><span class="dot dot-bridged"></span> Bridging trigger</div>
      </div>
    </aside>

    <!-- Center: graph viewport -->
    <section id="panel-center">
      <div id="cy"></div>
    </section>

    <!-- Right: output magnitude + degree distribution -->
    <aside id="panel-right">
      <h3>Output Signal</h3>
      <div class="output-box">
        <div class="output-label">‖y(t)‖<sub>2</sub></div>
        <div class="output-value" id="stat-output-norm">0.00</div>
      </div>

      <div class="output-chart-container">
        <canvas id="output-chart"></canvas>
      </div>
      <select id="output-window" class="output-window">
        <option value="50">last 50 steps</option>
        <option value="100" selected>last 100 steps</option>
        <option value="500">last 500 steps</option>
        <option value="1000">last 1000 steps</option>
        <option value="5000">last 5000 steps</option>
        <option value="all">all steps</option>
      </select>

      <h3>Node Activation Distribution</h3>
      <div class="chart-container">
        <canvas id="activation-chart"></canvas>
      </div>

      <h3>Edge Weight Distribution</h3>
      <div class="chart-container">
        <canvas id="weight-chart"></canvas>
      </div>

      <h3>Degree Distribution</h3>
      <div class="chart-container">
        <canvas id="degree-chart"></canvas>
      </div>
    </aside>

  </main>

  <script type="module" src="main.js"></script>
</body>
</html>
